# Lurus Switch 工作流水 / Process Log

> Last Updated: 2026-01-08

---

## 2026-01-08 微服务迁移完成 / Microservices Migration Completed

### 需求分析 / Requirements Analysis

将 Lurus Switch 从混合单体架构迁移到 Hertz + Kratos 微服务架构，完成 Phase 1-5 的核心服务构建和单元测试。

### 方法设计 / Design Approach

采用 Kratos 风格的分层架构（biz/data/service/server），每个服务独立部署：
- Gateway Service: Hertz 高性能 HTTP 代理
- Provider Service: 供应商配置管理
- Log Service: 日志存储与 OLAP 分析
- Billing Service: 计费与配额管理

### 修改摘要 / Changes Summary

#### 1. lurus-common 共享库
- `models/provider.go` - Provider 模型定义
- `models/user.go` - User/Quota 模型
- `models/request_log.go` - 日志模型
- `errors/errors.go` - 统一错误处理
- `nats/client.go` - NATS 客户端封装
- 测试文件: `provider_test.go`, `user_test.go`, `request_log_test.go`, `errors_test.go`

#### 2. provider-service
- `internal/biz/provider.go` - 业务逻辑层
- `internal/data/provider.go` - PostgreSQL + Redis 数据层
- `internal/server/http.go` - HTTP API
- `internal/biz/provider_test.go` - 单元测试

#### 3. log-service
- `internal/biz/log.go` - 日志业务逻辑
- `internal/data/log.go` - ClickHouse 数据层
- `internal/consumer/nats.go` - NATS 消费者
- `internal/biz/log_test.go` - 单元测试

#### 4. gateway-service
- `internal/proxy/relay.go` - 核心转发逻辑
- `internal/handler/*.go` - 路由处理器
- `internal/proxy/relay_test.go` - 单元测试

#### 5. billing-service
- `internal/biz/billing.go` - 计费业务逻辑
- `internal/data/billing.go` - PostgreSQL 数据层
- `internal/server/http.go` - REST API (Gin)
- `internal/consumer/nats.go` - NATS 消费者
- `internal/biz/billing_test.go` - 单元测试

#### 6. 开发环境
- `docker-compose.dev.yaml` - 完整开发环境
- `init-db.sql` - PostgreSQL 初始化
- `clickhouse-init.sql` - ClickHouse OLAP 表

### 最终结果 / Final Results

**测试结果**: 全部通过

| 模块 | 测试文件 | 状态 |
|------|---------|------|
| lurus-common/errors | errors_test.go | PASS |
| lurus-common/models | provider_test.go, user_test.go, request_log_test.go | PASS |
| provider-service/internal/biz | provider_test.go | PASS |
| billing-service/internal/biz | billing_test.go | PASS |
| gateway-service/internal/proxy | relay_test.go | PASS |
| log-service/internal/biz | log_test.go | PASS |

**编译结果**: 5 个服务全部成功编译
- gateway-service: 26MB
- provider-service: 26MB
- log-service: 25MB
- billing-service: 26MB
- lurus-common: library (no binary)

### 测试修复记录 / Test Fixes

1. **billing_test.go**: 浮点数精度比较问题，改用容差比较
2. **provider_test.go**: Mock 仓库需要存储副本防止指针污染
3. **provider_test.go**: NewProviderUsecase 需要传入 logger
4. **relay_test.go**: ID 生成测试改为验证格式而非唯一性

---

## 2026-01-08 Windows 原生部署完成 / Windows Native Deployment Completed

### 需求分析 / Requirements Analysis

在阿里云 Windows Server 2019 服务器上部署 Lurus Switch 微服务，提供 ai.lurus.cn 和 api.lurus.cn 服务。

### 方法设计 / Design Approach

由于阿里云 VM 不支持嵌套虚拟化（无法运行 Docker Desktop），采用 Windows 原生部署：
- 各服务编译为独立 .exe 文件
- 使用 PowerShell 脚本启动服务
- Caddy 作为边缘代理处理 Host+Path 路由

### 部署架构 / Deployment Architecture

```
Internet → Caddy :80 → ┬─ api.lurus.cn → new-api:3000
                       │
                       └─ ai.lurus.cn ─┬─ /v1/messages → gateway:18100
                                       ├─ /responses → gateway:18100
                                       ├─ /health → gateway:18100
                                       └─ /* → new-api:3000 (frontend)
```

### 服务状态 / Service Status

| 服务 | 端口 | 部署位置 | 状态 |
|------|------|---------|------|
| PostgreSQL | 5432 | D:\PostgreSQL | ✅ 运行中 |
| Redis | 6379 | D:\tools\redis | ✅ 运行中 |
| NATS | 4222 | D:\services\nats | ✅ 运行中 |
| new-api | 3000 | D:\services\new-api | ✅ 运行中 |
| gateway-hertz | 18100 | D:\services\gateway | ✅ 运行中 |
| Caddy | 80 | D:\services\caddy | ✅ 运行中 |

### 技术要点 / Technical Notes

1. **Hertz 路由 Gemini API**:
   - 问题: Hertz 不支持 `/:model\:action` 格式的路由
   - 解决: 使用 `/*modelAction` 通配符 + HandleModelAction 方法解析

2. **Caddy 智能路由**:
   - 同一域名 ai.lurus.cn 同时提供 API 和前端服务
   - 使用 `@ai_gateway` matcher 区分 API 路由和前端路由

3. **IIS 端口冲突**:
   - 问题: IIS 默认占用 80/443 端口
   - 解决: 停止 W3SVC 和 WAS 服务

### 验证结果 / Verification Results

```powershell
# 本地测试
curl localhost:18100/health           # {"status":"healthy"}
curl localhost:3000/api/status        # new-api status

# 外部测试
curl http://ai.lurus.cn/health        # {"status":"healthy"}
curl http://api.lurus.cn/api/status   # new-api status
```

---

*Generated by Claude Code | 2026-01-08*
