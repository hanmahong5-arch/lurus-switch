# Lurus Switch Production Stack
# 统一微服务部署配置
#
# 域名映射:
#   - api.lurus.cn      → new-api (:3000) - LLM Gateway
#   - ai.lurus.cn       → gateway-service (:18100) + Portal UI - CLI Proxy
#   - lurus.cn          → Static (ailurus) + API proxy - Marketing Site
#   - platform.lurus.cn → new-api (:3000) - Dashboard
#   - portal.lurus.cn   → Static (portal) - Nuxt SSG
#   - update.lurus.cn   → 保留在 IIS
#   - grafana.lurus.cn  → grafana (:3000) - Monitoring
#
# Usage:
#   docker-compose -f docker-compose.production.yml up -d
#
# Prerequisites:
#   - Create .env file with secrets
#   - Configure DNS records for domains
#   - Copy static files to ../sites/ directory

version: '3.8'

services:
  # ============================================================
  # Edge Proxy (Caddy - Auto HTTPS + Reverse Proxy)
  # 替代 IIS/nginx，统一入口
  # ============================================================
  caddy:
    image: caddy:2-alpine
    container_name: lurus-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - ./logs/caddy:/var/log/caddy
      # Static sites (migrated from IIS)
      - ../sites/ailurus:/srv/ailurus:ro
      - ../lurus-portal/.output/public:/srv/portal:ro
    environment:
      - ACME_EMAIL=${ACME_EMAIL:-admin@lurus.cn}
    depends_on:
      - new-api
      - gateway-service
    networks:
      - lurus-edge
      - lurus-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:2019/config/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================
  # LLM Gateway Layer
  # ============================================================

  # NEW-API: 统一 LLM 网关 (api.lurus.cn)
  new-api:
    image: calciumion/new-api:latest
    container_name: lurus-new-api
    restart: unless-stopped
    command: --log-dir /app/logs
    volumes:
      - new-api-data:/data
      - new-api-logs:/app/logs
    environment:
      - SQL_DSN=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/new_api?sslmode=disable
      - REDIS_CONN_STRING=redis://:${REDIS_PASSWORD}@redis:6379/0
      - TZ=Asia/Shanghai
      - BATCH_UPDATE_ENABLED=true
      - ERROR_LOG_ENABLED=true
      - DAILY_QUOTA_ENABLED=true
      - SESSION_SECRET=${SESSION_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:3000/api/status | grep -o '\"success\":\\s*true' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    # Internal only, exposed via Caddy
    expose:
      - "3000"

  # Gateway Service: LLM 代理网关 (ai.lurus.cn)
  gateway-service:
    build:
      context: ..
      dockerfile: gateway-service/Dockerfile
    container_name: lurus-gateway
    restart: unless-stopped
    environment:
      - PROVIDER_SERVICE_URL=http://provider-service:18101
      - BILLING_SERVICE_URL=http://billing-service:18103
      - LOG_SERVICE_URL=http://log-service:18102
      - NEW_API_URL=http://new-api:3000
      - NATS_URL=nats://nats:4222
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - TRACING_ENABLED=true
      - TRACING_ENDPOINT=jaeger:4317
    depends_on:
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
      provider-service:
        condition: service_healthy
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:18100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    expose:
      - "18100"

  # ============================================================
  # Microservices (Kratos)
  # ============================================================

  # Provider Service: 供应商配置管理
  provider-service:
    build:
      context: ..
      dockerfile: provider-service/Dockerfile
    container_name: lurus-provider
    restart: unless-stopped
    environment:
      - DATABASE_DSN=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/lurus_provider?sslmode=disable
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - NATS_URL=nats://nats:4222
      - CONSUL_ADDR=consul:8500
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:18101/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    expose:
      - "18101"

  # Log Service: 日志分析 (ClickHouse OLAP)
  log-service:
    build:
      context: ..
      dockerfile: log-service/Dockerfile
    container_name: lurus-log
    restart: unless-stopped
    environment:
      - CLICKHOUSE_DSN=clickhouse://${CLICKHOUSE_USER}:${CLICKHOUSE_PASSWORD}@clickhouse:9000/lurus_logs
      - NATS_URL=nats://nats:4222
      - CONSUL_ADDR=consul:8500
    depends_on:
      clickhouse:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:18102/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    expose:
      - "18102"

  # Billing Service: 计费认证
  billing-service:
    build:
      context: ..
      dockerfile: billing-service/Dockerfile
    container_name: lurus-billing
    restart: unless-stopped
    environment:
      - DATABASE_DSN=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/lurus_billing?sslmode=disable
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - NATS_URL=nats://nats:4222
      - CONSUL_ADDR=consul:8500
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:18103/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    expose:
      - "18103"

  # Sync Service: 会话同步 + Admin API
  sync-service:
    build:
      context: ..
      dockerfile: sync-service/Dockerfile
    container_name: lurus-sync
    restart: unless-stopped
    environment:
      - DATABASE_DSN=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/lurus_sync?sslmode=disable
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - NATS_URL=nats://nats:4222
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    expose:
      - "8081"

  # ============================================================
  # Infrastructure
  # ============================================================

  # PostgreSQL (主数据库)
  postgres:
    image: postgres:16-alpine
    container_name: lurus-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: lurus
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/init-databases.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ClickHouse (OLAP 日志分析)
  clickhouse:
    image: clickhouse/clickhouse-server:24-alpine
    container_name: lurus-clickhouse
    restart: unless-stopped
    environment:
      CLICKHOUSE_USER: ${CLICKHOUSE_USER}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
      CLICKHOUSE_DB: lurus_logs
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - ./clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Redis (缓存 + 队列)
  redis:
    image: redis:7-alpine
    container_name: lurus-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # NATS (消息总线)
  nats:
    image: nats:2.10-alpine
    container_name: lurus-nats
    restart: unless-stopped
    command:
      - "--config=/etc/nats/nats-server.conf"
    volumes:
      - nats-data:/data
      - ./nats/nats-server.conf:/etc/nats/nats-server.conf:ro
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Consul (服务发现)
  consul:
    image: hashicorp/consul:1.17
    container_name: lurus-consul
    restart: unless-stopped
    command: agent -server -bootstrap-expect=1 -ui -client=0.0.0.0 -data-dir=/consul/data
    volumes:
      - consul-data:/consul/data
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================================
  # Observability
  # ============================================================

  # Prometheus (指标收集)
  prometheus:
    image: prom/prometheus:v2.51.0
    container_name: lurus-prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/rules:/etc/prometheus/rules:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Grafana (仪表盘)
  grafana:
    image: grafana/grafana:10.4.1
    container_name: lurus-grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-clickhouse-datasource
      - GF_SERVER_ROOT_URL=https://grafana.lurus.cn
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    expose:
      - "3000"

  # Jaeger (分布式追踪)
  jaeger:
    image: jaegertracing/all-in-one:1.54
    container_name: lurus-jaeger
    restart: unless-stopped
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:14269/"]
      interval: 30s
      timeout: 10s
      retries: 3
    expose:
      - "16686"
      - "4317"
      - "4318"

  # Alertmanager (告警)
  alertmanager:
    image: prom/alertmanager:v0.27.0
    container_name: lurus-alertmanager
    restart: unless-stopped
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    networks:
      - lurus-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9093/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

# ============================================================
# Volumes
# ============================================================
volumes:
  # Edge
  caddy_data:
  caddy_config:
  # Services
  new-api-data:
  new-api-logs:
  # Infrastructure
  postgres-data:
  clickhouse-data:
  redis-data:
  nats-data:
  consul-data:
  # Observability
  prometheus-data:
  grafana-data:
  alertmanager-data:

# ============================================================
# Networks
# ============================================================
networks:
  # External facing (Caddy only)
  lurus-edge:
    name: lurus-edge
    driver: bridge
  # Internal services
  lurus-internal:
    name: lurus-internal
    driver: bridge
    internal: true
