# Lurus Switch Ingress Configuration
# Uses Traefik (K3S default ingress controller)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: lurus-ingress
  namespace: lurus-system
  annotations:
    # Traefik annotations
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    # cert-manager for automatic TLS
    cert-manager.io/cluster-issuer: letsencrypt-prod
    # Request timeout for AI API calls
    traefik.ingress.kubernetes.io/router.middlewares: lurus-system-timeout@kubernetescrd
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - api.lurus.cn
        - ai.lurus.cn
      secretName: lurus-tls
  rules:
    # api.lurus.cn -> new-api (management console)
    - host: api.lurus.cn
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: new-api
                port:
                  number: 3000

    # ai.lurus.cn -> gateway-service (AI API) + new-api (frontend)
    - host: ai.lurus.cn
      http:
        paths:
          # Claude API
          - path: /v1/messages
            pathType: Prefix
            backend:
              service:
                name: gateway-service
                port:
                  number: 18100
          # Codex API
          - path: /responses
            pathType: Prefix
            backend:
              service:
                name: gateway-service
                port:
                  number: 18100
          # OpenAI compatible API
          - path: /v1/chat/completions
            pathType: Prefix
            backend:
              service:
                name: gateway-service
                port:
                  number: 18100
          - path: /chat/completions
            pathType: Prefix
            backend:
              service:
                name: gateway-service
                port:
                  number: 18100
          # Gemini API
          - path: /v1beta
            pathType: Prefix
            backend:
              service:
                name: gateway-service
                port:
                  number: 18100
          # Health/Metrics
          - path: /health
            pathType: Exact
            backend:
              service:
                name: gateway-service
                port:
                  number: 18100
          - path: /metrics
            pathType: Exact
            backend:
              service:
                name: gateway-service
                port:
                  number: 18100
          # Default to new-api frontend
          - path: /
            pathType: Prefix
            backend:
              service:
                name: new-api
                port:
                  number: 3000
---
# Traefik Middleware for timeout configuration
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: timeout
  namespace: lurus-system
spec:
  headers:
    customRequestHeaders:
      X-Forwarded-Proto: https
  # Note: For streaming responses, configure in IngressRoute instead
---
# cert-manager ClusterIssuer for Let's Encrypt
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    email: admin@lurus.cn
    server: https://acme-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      name: letsencrypt-prod-account-key
    solvers:
      - http01:
          ingress:
            class: traefik
