# Lurus Switch Edge Proxy Configuration
# Caddy automatically handles HTTPS via Let's Encrypt
#
# Domains:
#   - api.lurus.cn       → new-api (LLM Gateway)
#   - ai.lurus.cn        → gateway-service (CLI Proxy) + Portal UI
#   - lurus.cn           → ailurus marketing site + API proxy
#   - platform.lurus.cn  → NEW-API (dashboard/management)
#   - portal.lurus.cn    → Nuxt SSG frontend
#   - update.lurus.cn    → Client update files
#   - grafana.lurus.cn   → Grafana Dashboard

# Global settings
{
    email {$ACME_EMAIL}
    # Staging for testing (uncomment for production)
    # acme_ca https://acme-v02.api.letsencrypt.org/directory
}

# ============================================================
# api.lurus.cn - NEW-API LLM Gateway
# ============================================================
api.lurus.cn {
    reverse_proxy new-api:3000 {
        # Health check
        health_uri /api/status
        health_interval 30s
        health_timeout 10s

        # Headers
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    # Security headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        Referrer-Policy strict-origin-when-cross-origin
        -Server
    }

    # Logging
    log {
        output file /var/log/caddy/api.log {
            roll_size 100mb
            roll_keep 10
        }
    }
}

# ============================================================
# ai.lurus.cn - Gateway Service (LLM Proxy for CLI tools) + Portal UI
# ============================================================
ai.lurus.cn {
    # API routes - reverse proxy to gateway-service with long timeout for streaming
    handle /v1/* {
        reverse_proxy gateway-service:18100 {
            transport http {
                response_header_timeout 300s
                read_timeout 300s
                write_timeout 300s
            }

            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Static frontend (Nuxt SSG output)
    handle {
        root * /srv/portal
        try_files {path} /index.html
        file_server {
            precompressed gzip br
        }
    }

    # CORS for CLI tools
    header {
        Access-Control-Allow-Origin *
        Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Access-Control-Allow-Headers "Authorization, Content-Type, X-Api-Key, Anthropic-Version"
        -Server
    }

    log {
        output file /var/log/caddy/ai.log {
            roll_size 100mb
            roll_keep 10
        }
    }
}

# ============================================================
# lurus.cn - Ailurus Marketing Site + API Proxy
# ============================================================
lurus.cn, www.lurus.cn {
    root * /srv/ailurus

    # API routes forward to NEW-API
    handle /api/* {
        reverse_proxy new-api:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    handle /v1/* {
        reverse_proxy new-api:3000 {
            header_up Host {host}
            header_up X-Forwarded-For {remote_host}
        }
    }

    handle /dashboard* {
        reverse_proxy new-api:3000 {
            header_up Host {host}
            header_up X-Forwarded-For {remote_host}
        }
    }

    # Static files with .html extension fallback
    handle {
        try_files {path} {path}.html {path}/ /index.html
        file_server
    }

    # Security headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options SAMEORIGIN
        Referrer-Policy strict-origin-when-cross-origin
        -Server
    }

    log {
        output file /var/log/caddy/lurus.log {
            roll_size 50mb
            roll_keep 5
        }
    }
}

# ============================================================
# platform.lurus.cn - NEW-API Dashboard (Pure Reverse Proxy)
# ============================================================
platform.lurus.cn {
    reverse_proxy new-api:3000 {
        # WebSocket support for real-time features
        transport http {
            response_header_timeout 120s
        }

        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    # Security headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options SAMEORIGIN
        -Server
    }

    log {
        output file /var/log/caddy/platform.log {
            roll_size 50mb
            roll_keep 5
        }
    }
}

# ============================================================
# portal.lurus.cn - Web Portal (Nuxt SSG)
# ============================================================
portal.lurus.cn {
    root * /srv/portal

    # SPA routing - try files, fallback to index.html
    try_files {path} /index.html

    file_server {
        precompressed gzip br
    }

    # Cache static assets (long-term caching for hashed filenames)
    @static {
        path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # Security headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options SAMEORIGIN
        -Server
    }

    log {
        output file /var/log/caddy/portal.log {
            roll_size 50mb
            roll_keep 5
        }
    }
}

# update.lurus.cn - 保留在 IIS 上运行，不迁移

# ============================================================
# grafana.lurus.cn - Monitoring Dashboard
# ============================================================
grafana.lurus.cn {
    reverse_proxy grafana:3000 {
        health_uri /api/health
        health_interval 30s
    }

    # Basic auth for extra security (optional)
    # basicauth /* {
    #     admin $2a$14$xxx
    # }

    log {
        output file /var/log/caddy/grafana.log {
            roll_size 50mb
            roll_keep 5
        }
    }
}

# ============================================================
# Internal endpoints (only accessible from internal network)
# ============================================================

# Admin API via sync-service (internal only, not exposed externally)
# Access via VPN or internal network
:8081 {
    reverse_proxy sync-service:8081

    # Restrict to internal IPs only
    @blocked not remote_ip 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 127.0.0.1
    respond @blocked "Forbidden" 403
}

# Jaeger UI (internal only)
:16686 {
    reverse_proxy jaeger:16686

    @blocked not remote_ip 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 127.0.0.1
    respond @blocked "Forbidden" 403
}
